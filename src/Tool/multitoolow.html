<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½å¤„ç†å·¥å…· | Overwatch Style</title>
    <!-- å¼•å…¥ SheetJS ç”¨äº Excel å¯¼å‡ºåŠè§£æ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            /* æ ¸å¿ƒé¢œè‰² */
            --ow-orange: #f99e1a;
            --ow-orange-hover: #ffb042;
            --ow-blue: #00c3ff;
            
            /* é»˜è®¤æš—è‰²ä¸»é¢˜å˜é‡ (ä½œä¸ºåŸºç¡€ï¼Œé€šè¿‡ç±»åè¦†ç›–) */
            --bg-color: #1a1c23;
            --header-bg: linear-gradient(90deg, #292f36 0%, #1a1c23 100%);
            --text-main: #f0edf2;
            --text-muted: #9ea3b0;
            --card-bg: rgba(41, 47, 54, 0.85);
            --input-bg: rgba(0, 0, 0, 0.3);
            --border-color: rgba(255, 255, 255, 0.15);
            --th-bg: rgba(0, 0, 0, 0.4);
            --nav-inactive: rgba(255, 255, 255, 0.05);
            --nav-hover: rgba(255, 255, 255, 0.1);
            --result-box-bg: rgba(0,0,0,0.2);
            --shadow: rgba(0,0,0,0.5);
        }

        /* äº®è‰²ä¸»é¢˜è¦†ç›– (ç°åœ¨è®¾ä¸ºé»˜è®¤) */
        body.light-theme {
            --bg-color: #f0f2f5;
            --header-bg: linear-gradient(90deg, #ffffff 0%, #e0e0e0 100%);
            --text-main: #2c3e50;
            --text-muted: #57606f;
            --card-bg: rgba(255, 255, 255, 0.95);
            --input-bg: rgba(255, 255, 255, 1);
            --border-color: rgba(0, 0, 0, 0.1);
            --th-bg: rgba(0, 0, 0, 0.05);
            --nav-inactive: rgba(0, 0, 0, 0.05);
            --nav-hover: rgba(0, 0, 0, 0.1);
            --result-box-bg: rgba(0, 0, 0, 0.03);
            --shadow: rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- é€šç”¨ UI ç»„ä»¶ --- */
        .ow-header {
            background: var(--header-bg);
            border-bottom: 4px solid var(--ow-orange);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px var(--shadow);
            transition: background 0.3s;
        }

        .ow-title {
            font-style: italic;
            font-weight: 900;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-main); /* é€‚é…ä¸»é¢˜ */
            text-shadow: 2px 2px 0px var(--ow-orange);
        }

        /* äº®è‰²æ¨¡å¼ä¸‹æ ‡é¢˜å»æ‰é˜´å½±æˆ–æ”¹è‰²ï¼Œé˜²æ­¢çœ‹ä¸æ¸… */
        body.light-theme .ow-title {
            color: #2c3e50;
            text-shadow: 2px 2px 0px rgba(249, 158, 26, 0.4);
        }

        .container {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* å¯¼èˆªæ  */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            overflow-x: auto; /* ç§»åŠ¨ç«¯é˜²æº¢å‡º */
        }

        .nav-btn {
            background: var(--nav-inactive);
            border: none;
            color: var(--text-muted);
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            font-style: italic;
            text-transform: uppercase;
            cursor: pointer;
            transform: skewX(-20deg);
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
            white-space: nowrap;
        }

        .nav-btn span {
            display: block;
            transform: skewX(20deg); /* åå‘å€¾æ–œæ–‡å­— */
        }

        .nav-btn:hover {
            background: var(--nav-hover);
            color: var(--text-main);
        }

        .nav-btn.active {
            background: var(--text-main); /* äº®è‰²æ¨¡å¼ä¸‹å˜é»‘ï¼Œæš—è‰²æ¨¡å¼ä¸‹å˜ç™½ */
            color: var(--bg-color); /* åè‰² */
            border-left: 6px solid var(--ow-orange);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        
        body.light-theme .nav-btn.active {
            background: #fff;
            color: #2c3e50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* å†…å®¹åŒºåŸŸ */
        .tab-content {
            display: none;
            flex: 1;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
            transition: background 0.3s;
        }

        /* è£…é¥°æ€§è§’è½ */
        .card::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px;
            width: 20px; height: 20px;
            border-top: 3px solid var(--ow-orange);
            border-left: 3px solid var(--ow-orange);
        }
        .card::after {
            content: '';
            position: absolute;
            bottom: -1px; right: -1px;
            width: 20px; height: 20px;
            border-bottom: 3px solid var(--ow-orange);
            border-right: 3px solid var(--ow-orange);
        }

        /* æŒ‰é’®é£æ ¼ */
        .btn {
            background-color: var(--ow-orange);
            color: #1a1c23; /* æŒ‰é’®æ–‡å­—ä¿æŒæ·±è‰²ä»¥ä¿è¯å¯¹æ¯”åº¦ */
            border: none;
            padding: 8px 24px;
            font-weight: 700;
            font-style: italic;
            text-transform: uppercase;
            cursor: pointer;
            transform: skewX(-15deg);
            transition: all 0.1s;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn span {
            display: block;
            transform: skewX(15deg);
        }

        .btn:hover {
            background-color: var(--ow-orange-hover);
            transform: skewX(-15deg) scale(1.05);
            box-shadow: 0 0 10px var(--ow-orange);
        }

        .btn-secondary {
            background-color: var(--ow-blue);
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #33d4ff;
            box-shadow: 0 0 10px var(--ow-blue);
        }
        
        .btn-theme {
            padding: 8px 15px;
            margin-right: 0;
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        .btn-theme:hover {
            background: rgba(255,255,255,0.2);
            color: var(--ow-orange);
            box-shadow: none;
        }
        body.light-theme .btn-theme {
             background: rgba(0,0,0,0.05);
        }

        /* è¾“å…¥æ¡† */
        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px;
            font-family: monospace;
            resize: none;
            outline: none;
            transition: border-color 0.2s, background 0.3s, color 0.3s;
            font-size: 1.1rem; /* å¢å¤§å­—ä½“ */
            /* ç§»é™¤é»˜è®¤çš„ overflow: hiddenï¼Œä»¥ä¾¿ JS æ§åˆ¶ */
        }

        textarea:focus, input:focus {
            border-color: var(--ow-blue);
        }

        /* ç‰¹å®šè¾“å…¥æ¡†æ ·å¼ */
        #addrInput {
            min-height: 150px; /* åˆå§‹é«˜åº¦ */
            overflow-y: hidden; /* é»˜è®¤éšè—å‚ç›´æ»šåŠ¨æ¡ */
        }

        #convertInput {
            min-height: 100px; /* åˆå§‹è¾ƒå°é«˜åº¦ */
            overflow-y: hidden;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 800px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            min-width: 100px;
        }

        th {
            background: var(--th-bg);
            color: var(--ow-orange);
            text-transform: uppercase;
            font-weight: bold;
            white-space: nowrap;
        }

        /* åºå·åˆ—å®½åº¦ */
        th:first-child, td:first-child {
            width: 60px;
            min-width: 60px;
            text-align: center;
            color: var(--text-muted);
            font-family: monospace;
            user-select: none;
        }

        td[contenteditable="true"]:hover {
            background: rgba(128, 128, 128, 0.1);
            cursor: text;
        }

        td[contenteditable="true"]:focus {
            background: rgba(0, 195, 255, 0.1);
            outline: 1px solid var(--ow-blue);
        }

        /* --- å·¥å…· 2 & 3 çš„ç‰¹å®šå¸ƒå±€ --- */
        .tool-layout {
            display: flex;
            gap: 20px;
            height: 100%;
        }
        
        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .side-panel {
            flex: 1;
            background: var(--result-box-bg);
            padding: 15px;
            border-left: 2px solid var(--border-color);
        }

        .stat-item {
            margin-bottom: 15px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .stat-value {
            color: var(--ow-blue);
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Impact', sans-serif;
        }

        .stat-list {
            list-style: none;
            font-size: 0.9rem;
        }
        .stat-list li {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            padding: 4px 0;
        }

        /* æ¯”è¾ƒå·¥å…·å¸ƒå±€ */
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .result-box {
            background: var(--result-box-bg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .result-header {
            background: var(--nav-inactive);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-title {
            color: var(--ow-orange);
            font-weight: bold;
        }

        .copy-btn {
            font-size: 0.8rem;
            padding: 2px 8px;
            transform: none;
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
        }
        .copy-btn span { transform: none; }
        .copy-btn:hover {
            background: var(--ow-blue);
            color: white;
            border-color: var(--ow-blue);
            transform: none;
            box-shadow: none;
        }

        .result-content {
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 1.1rem; /* å¢å¤§ç»“æœæ¡†å­—å· */
            white-space: pre-wrap;
            color: var(--text-main);
        }

        .settings-group {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            color: var(--text-main);
        }

        /* --- æ–°å¢ï¼šæ‹–æ‹½ä¸Šä¼ åŒºåŸŸæ ·å¼ --- */
        .drop-zone {
            border: 2px dashed var(--border-color);
            background: rgba(0,0,0,0.03);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--ow-blue);
            background: rgba(0, 195, 255, 0.05);
            transform: scale(1.01);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.7;
        }
        
        /* ä¿®å¤å·¥å…·æ æŒ‰é’®é®æŒ¡é—®é¢˜ */
        .toolbar-fix {
            margin-bottom: 15px; 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            align-items: center;
            padding-left: 10px; /* å¢åŠ å·¦ä¾§å†…è¾¹è·é˜²æ­¢å€¾æ–œæŒ‰é’®è¢«åˆ‡ */
        }

        /* ç»Ÿè®¡å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none; /* é»˜è®¤éšè— */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        .stats-table th, .stats-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            color: var(--text-main);
        }
        .stats-table th { color: var(--ow-orange); font-weight: bold; }

        /* ç§»åŠ¨ç«¯é€‚é…å¾®è°ƒ */
        @media (max-width: 768px) {
            .tool-layout { flex-direction: column; }
            .compare-grid, .result-grid { grid-template-columns: 1fr; }
            .nav-tabs { overflow-x: auto; }
        }
    </style>
</head>
<body class="light-theme">

    <header class="ow-header">
        <div class="ow-title">å¤šåŠŸèƒ½å¤„ç†å·¥å…·</div>
        <button class="btn btn-theme" onclick="toggleTheme()" id="themeBtn" title="åˆ‡æ¢äº®/æš—æ¨¡å¼">
            <span>ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</span>
        </button>
    </header>

    <div class="container">
        <!-- å¯¼èˆª (é‡æ–°æ’åº) -->
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('tab1', this)"><span>ğŸ“ åœ°å€å¤„ç†</span></button>
            <button class="nav-btn" onclick="switchTab('tab2', this)"><span>ğŸ“Š è¡¨æ ¼è§£æ</span></button>
            <button class="nav-btn" onclick="switchTab('tab3', this)"><span>âš–ï¸ å•å·æ¯”è¾ƒ</span></button>
            <button class="nav-btn" onclick="switchTab('tab4', this)"><span>ğŸ”€ å•å·è½¬æ¢</span></button>
        </div>

        <!-- Tab 1: åœ°å€å¤„ç† -->
        <div id="tab1" class="tab-content active">
            <div class="card">
                <!-- å¢åŠ äº† padding-left: 10px é˜²æ­¢æŒ‰é’®è¢«é®æŒ¡ -->
                <div class="toolbar-fix">
                    <button class="btn btn-secondary" onclick="processAddress()"><span>âš¡ å¼€å§‹æ™ºèƒ½è§£æ</span></button>
                    <button class="btn btn-secondary" onclick="showProductStats()"><span>ğŸ“Š å•†å“ç»Ÿè®¡</span></button>
                    <button class="btn" onclick="copyAddressContent()"><span>ğŸ“‹ å¤åˆ¶å†…å®¹</span></button>
                    <button class="btn" onclick="exportData('csv')"><span>ğŸ“„ å¯¼å‡º CSV</span></button>
                    <button class="btn" onclick="exportData('xlsx')"><span>ğŸ“Š å¯¼å‡º Excel</span></button>
                    <button class="btn" style="background: #e74c3c;" onclick="clearAddress()"><span>ğŸ—‘ï¸ æ¸…ç©º</span></button>
                    <span style="margin-left: auto; color: var(--text-muted); font-style: italic;">
                        å…±å¤„ç† <strong style="color: var(--ow-blue);" id="addrCount">0</strong> æ¡æ•°æ®
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div>
                        <label style="color: var(--ow-orange); font-weight: bold;">åŸå§‹æ•°æ®è¾“å…¥ï¼š</label>
                        <textarea id="addrInput" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼š
1. æ ‡å‡†ä¸‰è¡Œ
2. æŒ¤åœ¨ä¸€è¡Œ (é‚“åå¤...19593...)
3. åˆ†å¼€æ ¼å¼
æ”¯æŒä¸­æ–‡å¥å·æˆ–åŒç©ºæ ¼åˆ†éš”å•†å“"></textarea>
                    </div>
                    <div>
                        <label style="color: var(--ow-orange); font-weight: bold;">è§£æç»“æœ (å¯ç›´æ¥ç¼–è¾‘)ï¼š</label>
                        <div class="table-container">
                            <table id="addrTable">
                                <thead>
                                    <tr>
                                        <th>åºå·</th>
                                        <th>æ”¶ä»¶äºº(å¿…å¡«)</th>
                                        <th>æ‰‹æœºå·(å¿…å¡«)</th>
                                        <th>æ”¶è´§åœ°å€(å¿…å¡«)</th>
                                        <th>å•†å“ä¿¡æ¯(éå¿…å¡«)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: è¡¨æ ¼è§£æ -->
        <div id="tab2" class="tab-content">
            <div class="card">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
                    <!-- æ·»åŠ  multiple å±æ€§æ”¯æŒå¤šæ–‡ä»¶ -->
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" hidden multiple onchange="handleFileSelect(event)">
                    <div class="upload-icon">ğŸ“‚</div>
                    <p style="font-size: 1.2rem; font-weight: bold; color: var(--text-main);">ç‚¹å‡»æˆ–æ‹–æ‹½ Excel/CSV æ–‡ä»¶è‡³æ­¤</p>
                    <p style="font-size: 0.9em; color: var(--text-muted);">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œè‡ªåŠ¨åˆå¹¶æ•°æ®</p>
                </div>

                <!-- æ§åˆ¶æ  (åˆå§‹éšè—) -->
                <div id="excelControls" style="display: none; margin-bottom: 15px; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn" onclick="copyExcelContent()"><span>ğŸ“‹ å¤åˆ¶è¡¨æ ¼å†…å®¹</span></button>
                    <button class="btn btn-secondary" onclick="copyReturnLogistics()"><span>ğŸ“¦ ä»…å¤åˆ¶é€€è´§ç‰©æµå•å·</span></button>
                    <button class="btn" style="background: #e74c3c;" onclick="clearExcelData()"><span>ğŸ—‘ï¸ æ¸…ç©º</span></button>
                    <span style="margin-left: auto; color: var(--text-muted);">
                        å…±è§£æ <strong style="color: var(--ow-blue);" id="excelRowCount">0</strong> è¡Œæ•°æ®
                    </span>
                </div>

                <!-- è¡¨æ ¼å±•ç¤ºåŒº -->
                <div class="table-container" id="excelTableContainer" style="min-height: 200px;">
                    <div id="excelPlaceholder" style="padding: 40px; text-align: center; color: var(--text-muted); font-style: italic;">
                        æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶
                    </div>
                    <table id="excelTable" style="display: none;">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 3: å•å·æ¯”è¾ƒ -->
        <div id="tab3" class="tab-content">
            <div class="card">
                <div class="compare-grid">
                    <div>
                        <label style="color: var(--ow-orange);">åˆ—è¡¨ A (åŸºå‡†)</label>
                        <textarea id="compInputA" style="height: 150px;" placeholder="ç²˜è´´å•å·ç»„ A"></textarea>
                    </div>
                    <div>
                        <label style="color: var(--ow-blue);">åˆ—è¡¨ B (å¯¹æ¯”)</label>
                        <textarea id="compInputB" style="height: 150px;" placeholder="ç²˜è´´å•å·ç»„ B"></textarea>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn" onclick="compareLists()" style="padding: 10px 50px; font-size: 1.2em;"><span>âš–ï¸ å¼€å§‹æ¯”è¾ƒ</span></button>
                    <p style="margin-top: 5px; font-size: 0.9em; color: var(--text-muted);">*å°†è‡ªåŠ¨åº”ç”¨â€œå•å·è½¬æ¢â€ä¸­çš„æœ€å°é•¿åº¦è¿‡æ»¤è®¾ç½®</p>
                </div>

                <div class="result-grid">
                    <!-- å…±æœ‰ -->
                    <div class="result-box">
                        <div class="result-header">
                            <span class="result-title">å…±æœ‰å•å· <span id="countCommon">(0)</span></span>
                            <button class="btn copy-btn" onclick="copyText('resCommon')"><span>ğŸ“‹ å¤åˆ¶</span></button>
                        </div>
                        <div id="resCommon" class="result-content"></div>
                    </div>
                    <!-- A ç‹¬æœ‰ -->
                    <div class="result-box">
                        <div class="result-header">
                            <span class="result-title" style="color: var(--text-main);">A ç‹¬æœ‰ <span id="countAOnly">(0)</span></span>
                            <button class="btn copy-btn" onclick="copyText('resAOnly')"><span>ğŸ“‹ å¤åˆ¶</span></button>
                        </div>
                        <div id="resAOnly" class="result-content"></div>
                    </div>
                    <!-- B ç‹¬æœ‰ -->
                    <div class="result-box">
                        <div class="result-header">
                            <span class="result-title" style="color: var(--text-main);">B ç‹¬æœ‰ <span id="countBOnly">(0)</span></span>
                            <button class="btn copy-btn" onclick="copyText('resBOnly')"><span>ğŸ“‹ å¤åˆ¶</span></button>
                        </div>
                        <div id="resBOnly" class="result-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: å•å·è½¬æ¢ -->
        <div id="tab4" class="tab-content">
            <div class="card tool-layout">
                <div class="main-panel">
                    <!-- é«˜åº¦æ§åˆ¶åœ¨ CSS å’Œ JS ä¸­ -->
                    <textarea id="convertInput" placeholder="åœ¨æ­¤è¾“å…¥å•å·åˆ—è¡¨..."></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="convertFormat('comma')"><span>ğŸŒ­ è½¬ä¸ºé€—å·åˆ†éš”</span></button>
                        <button class="btn" onclick="convertFormat('newline')"><span>â¬‡ï¸ è½¬ä¸ºå•è¡Œæ’åˆ—</span></button>
                        <button class="btn btn-secondary" onclick="copyConvertResult()"><span>ğŸ“‹ å¤åˆ¶ç»“æœ</span></button>
                    </div>
                </div>
                <div class="side-panel">
                    <h4 style="color: var(--ow-orange); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">å®æ—¶æ•°æ®åˆ†æ</h4>
                    
                    <div class="stat-item">
                        <div class="stat-label">æ€»è¡Œæ•° / æœ‰æ•ˆå•å·</div>
                        <div class="stat-value"><span id="totalLines">0</span> / <span id="validCount">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">é‡å¤å•å·æ•°</div>
                        <div class="stat-value" style="color: #e74c3c;" id="dupCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å‰ç¼€åˆ†å¸ƒ (Top 5)</div>
                        <ul class="stat-list" id="prefixList">
                            <!-- JS å¡«å…… -->
                        </ul>
                    </div>

                    <div class="settings-group">
                        <label><input type="checkbox" id="autoRemoveDup" checked> è‡ªåŠ¨ç§»é™¤é‡å¤é¡¹</label>
                        <label>æœ€å°é•¿åº¦è¿‡æ»¤: <input type="number" id="minLength" value="10" style="width: 60px; padding: 2px;"> <small style="color:var(--text-muted)">(å…¨å±€ç”Ÿæ•ˆ)</small></label>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- å•†å“ç»Ÿè®¡å¼¹çª— -->
    <div id="statsModal" class="modal-overlay">
        <div class="modal-content card">
            <div class="modal-header">
                <h3 class="ow-title" style="font-size: 1.5rem;">å•†å“ç»Ÿè®¡æ±‡æ€»</h3>
                <button class="btn btn-theme" onclick="closeStats()" style="padding: 5px 12px;">âœ–</button>
            </div>
            <div class="modal-body">
                <table class="stats-table">
                    <thead><tr><th>å•†å“ä¿¡æ¯ (æ¬¾å·/é¢œè‰²/å°ºç )</th><th>æ•°é‡</th></tr></thead>
                    <tbody id="statsBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                 <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main);">æ€»è®¡: <span id="totalProductCount" style="color: var(--ow-blue)">0</span> ä»¶</div>
                 <button class="btn" onclick="copyStats()">ğŸ“‹ å¤åˆ¶ç»Ÿè®¡ç»“æœ</button>
            </div>
        </div>
    </div>

    <script>
        // --- ä¸»é¢˜åˆ‡æ¢ ---
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const btn = document.getElementById('themeBtn');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('ow-theme', isLight ? 'light' : 'dark');
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = localStorage.getItem('ow-theme');
        if (savedTheme === 'dark') {
            document.body.classList.remove('light-theme');
        } else {
            document.body.classList.add('light-theme');
        }

        // --- æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ ---
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            if(tabId === 'tab1') resizeAddrInput();
            if(tabId === 'tab4') resizeConvertInput(); // æ³¨æ„ ID å˜äº†
        }

        // --- è‡ªåŠ¨é«˜åº¦è°ƒæ•´å‡½æ•° ---

        function resizeAddrInput() {
            const el = document.getElementById('addrInput');
            if (!el || el.offsetParent === null) return; 

            el.style.height = 'auto';
            const rect = el.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const paddingBottom = 20; 
            const availableHeight = viewportHeight - rect.top - paddingBottom;
            
            if (el.scrollHeight > availableHeight) {
                el.style.height = Math.max(availableHeight, 150) + 'px';
                el.style.overflowY = 'auto';
            } else {
                el.style.height = Math.max(el.scrollHeight, 150) + 'px'; 
                el.style.overflowY = 'hidden';
            }
        }

        function resizeConvertInput() {
            const el = document.getElementById('convertInput');
            if (!el || el.offsetParent === null) return;

            el.style.height = 'auto';
            const rect = el.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const paddingBottom = 20; 
            const availableHeight = viewportHeight - rect.top - paddingBottom;
            
            if (el.scrollHeight > availableHeight) {
                el.style.height = Math.max(availableHeight, 100) + 'px';
                el.style.overflowY = 'auto';
            } else {
                el.style.height = Math.max(el.scrollHeight, 100) + 'px';
                el.style.overflowY = 'hidden';
            }
        }

        // --- ç»‘å®šäº‹ä»¶ç›‘å¬ ---
        const addrInput = document.getElementById('addrInput');
        addrInput.addEventListener('input', resizeAddrInput);

        const convertInputEl = document.getElementById('convertInput');
        convertInputEl.addEventListener('input', resizeConvertInput);

        window.addEventListener('resize', () => {
            if (document.getElementById('tab1').classList.contains('active')) {
                resizeAddrInput();
            } else if (document.getElementById('tab4').classList.contains('active')) {
                resizeConvertInput();
            }
        });


        // =======================
        // å·¥å…·ä¸€ï¼šåœ°å€å¤„ç†é€»è¾‘
        // =======================
        function processAddress() {
            const rawText = document.getElementById('addrInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const tbody = document.querySelector('#addrTable tbody');
            tbody.innerHTML = ''; 

            let recordCount = 0;

            const addRecordToTable = (rec) => {
                if (!rec) return;
                recordCount++;
                const tr = document.createElement('tr');
                const tdIndex = document.createElement('td');
                tdIndex.textContent = recordCount;
                tr.appendChild(tdIndex);

                const columns = [
                    rec.name || '',
                    rec.phone || '',
                    rec.addr || '',
                    rec.product || ''
                ];

                columns.forEach(text => {
                    const td = document.createElement('td');
                    td.contentEditable = "true";
                    td.textContent = text;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            };

            const phoneRegex = /(1[3-9]\d{9})|(\d{3,4}-?\d{7,8})/;
            let records = [];
            let tempName = "";
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                let phoneMatch = line.match(phoneRegex);

                if (phoneMatch) {
                    let phone = phoneMatch[0];
                    let prePhone = line.substring(0, line.indexOf(phone)).trim();
                    let postPhone = line.substring(line.indexOf(phone) + phone.length).trim();

                    let name = "";
                    if (prePhone) {
                        name = prePhone;
                    } else if (tempName) {
                        name = tempName;
                        tempName = "";
                    }

                    // ä¿ç•™å§“åä¸­çš„è™šæ‹Ÿå· [xxxx] å’Œ @...#ï¼Œä»…ç§»é™¤æœ«å°¾çº¯æ•°å­—
                    name = name.replace(/\d+$/, '').trim(); 

                    let addrFull = postPhone;
                    if (!addrFull && i + 1 < lines.length && !lines[i+1].match(phoneRegex)) {
                        addrFull = lines[i+1].trim();
                        i++;
                    }

                    let address = addrFull;
                    let product = "";
                    
                    address = address.trim();

                    // æ–°å¢ï¼šæ£€æµ‹åœ°å€ä¸­çš„ @...# æ ¼å¼è™šæ‹Ÿå·ï¼ˆå¦‚ @DX-MLP...#ï¼‰ï¼Œå¹¶æ·»åŠ åˆ°å§“åä¸­
                    // æ³¨æ„ï¼šè¯¥ä¿¡æ¯ä»ä¼šä¿ç•™åœ¨åœ°å€ä¸­
                    const virtualMatches = address.match(/@[\w-]+#/g);
                    if (virtualMatches) {
                        virtualMatches.forEach(code => {
                            // é¿å…é‡å¤æ·»åŠ 
                            if (!name.includes(code)) {
                                name += code;
                            }
                        });
                    }

                    const periodSplit = address.split('ã€‚');
                    const spaceSplit = address.split(/\s{2,}/); 

                    if (periodSplit.length > 1) {
                        address = periodSplit[0];
                        product = periodSplit.slice(1).join('ã€‚');
                    } else if (spaceSplit.length > 1) {
                        address = spaceSplit[0];
                        let remaining = spaceSplit.slice(1);
                        
                        let productStarted = false;
                        let finalProductParts = [];
                        
                        for (let part of remaining) {
                            // æ£€æµ‹æ˜¯å¦ä¸ºè™šæ‹Ÿå·æ ¼å¼ï¼š[xxx] æˆ– @xxx#
                            // ^@.*?#$ æ¶µç›–äº† @DX-MLP...# å’Œ @DX...#
                            if (!productStarted && /^(\[.*?\]|@.*?#)$/.test(part)) {
                                address += " " + part;
                            } else {
                                productStarted = true;
                                finalProductParts.push(part);
                            }
                        }
                        product = finalProductParts.join(' ');
                    }

                    records.push({ name, phone, addr: address, product });
                } else {
                    tempName = line;
                }
            }

            records.forEach(addRecordToTable);
            document.getElementById('addrCount').innerText = recordCount;
        }

        function clearAddress() {
            document.getElementById('addrInput').value = '';
            document.querySelector('#addrTable tbody').innerHTML = '';
            document.getElementById('addrCount').innerText = '0';
            resizeAddrInput(); 
        }

        function getFileName() {
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            return `åœ°å€ä¿¡æ¯${month}${day}${hour}`;
        }

        function copyAddressContent() {
            const rows = document.querySelectorAll('#addrTable tbody tr');
            if (rows.length === 0) {
                alert("æ²¡æœ‰å†…å®¹å¯å¤åˆ¶");
                return;
            }

            let textContent = "";
            rows.forEach(tr => {
                const cells = tr.querySelectorAll('td');
                const rowData = [
                    cells[1].innerText, 
                    cells[2].innerText, 
                    cells[3].innerText, 
                    cells[4].innerText
                ];
                textContent += rowData.join('\t') + '\n';
            });

            copyToClipboard(textContent);
        }

        // --- å•†å“ç»Ÿè®¡ç›¸å…³é€»è¾‘ ---
        function showProductStats() {
            const rows = document.querySelectorAll('#addrTable tbody tr');
            const counts = {};
            let total = 0;

            rows.forEach(tr => {
                // ç¬¬5åˆ—æ˜¯å•†å“ä¿¡æ¯ (index 4)
                const productText = tr.children[4].innerText.trim();
                if (!productText) return;

                // æ‹†åˆ†é€»è¾‘ï¼šæŒ‰ å¥å·ã€é€—å·ã€æ¢è¡Œ æ‹†åˆ†
                const items = productText.split(/[ã€‚ï¼Œ,\n]+/).map(s => s.trim()).filter(s => s);

                items.forEach(item => {
                    counts[item] = (counts[item] || 0) + 1;
                    total++;
                });
            });

            // æ’åºé€»è¾‘ï¼šå‹å·/é¢œè‰² -> å°ºç (ä»å°åˆ°å¤§)
            const sortedItems = Object.entries(counts).sort((a, b) => {
                const parseKey = (key) => {
                    // å°è¯•åˆ†ç¦»æ–‡æœ¬å’Œæœ«å°¾çš„æ•°å­—å°ºç 
                    // ä¾‹å¦‚ "2355ç™½æ·±è“43" -> base: "2355ç™½æ·±è“", size: 43
                    const match = key.match(/^(.*?)(\d+)$/);
                    if (match) {
                        return { base: match[1], size: parseInt(match[2], 10) };
                    }
                    // å¦‚æœæ²¡æœ‰æ•°å­—åç¼€ï¼Œè§†ä¸ºçº¯æ–‡æœ¬ï¼Œå°ºç è®¾ä¸º-1
                    return { base: key, size: -1 }; 
                };

                const pA = parseKey(a[0]);
                const pB = parseKey(b[0]);

                // 1. å…ˆæŒ‰å‰é¢çš„å‹å·/é¢œè‰²æ’åº (ä½¿ç”¨ localeCompare æ”¯æŒä¸­æ–‡è‡ªç„¶æ’åº)
                const baseDiff = pA.base.localeCompare(pB.base, 'zh-CN', { numeric: true });
                if (baseDiff !== 0) return baseDiff;

                // 2. å¦‚æœå‹å·é¢œè‰²ç›¸åŒï¼ŒæŒ‰å°ºç ä»å°åˆ°å¤§æ’åº
                return pA.size - pB.size;
            });

            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = '';

            sortedItems.forEach(([name, count]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${name}</td><td style="font-family:Impact; color:var(--ow-blue); font-size:1.1em;">${count}</td>`;
                tbody.appendChild(tr);
            });

            document.getElementById('totalProductCount').innerText = total;
            document.getElementById('statsModal').style.display = 'flex';
        }

        function closeStats() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function copyStats() {
            const rows = document.querySelectorAll('#statsBody tr');
            if (rows.length === 0) {
                alert("æ— ç»Ÿè®¡æ•°æ®");
                return;
            }
            let text = "å•†å“ä¿¡æ¯\tæ•°é‡\n";
            rows.forEach(tr => {
                text += `${tr.children[0].innerText}\t${tr.children[1].innerText}\n`;
            });
            text += `æ€»è®¡\t${document.getElementById('totalProductCount').innerText}`;
            
            copyToClipboard(text);
        }

        function exportData(type) {
            const table = document.getElementById('addrTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length === 0) {
                alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼");
                return;
            }

            const header = [
                'æ”¶ä»¶äºº(å¿…å¡«)', 
                'æ‰‹æœºå·(å¿…å¡«)', 
                'æ”¶è´§åœ°å€(å¿…å¡«)', 
                'å¹³å°è®¢å•å·ï¼ˆéå¿…å¡«ï¼‰', 
                'å•†å“ä¿¡æ¯(éå¿…å¡«)', 
                'è§„æ ¼ä¿¡æ¯(éå¿…å¡«)', 
                'å•†å“æ•°é‡(éå¿…å¡«)', 
                'é‡é‡kg(éå¿…å¡«)', 
                'å¤‡æ³¨(éå¿…å¡«)'
            ];
            
            const data = [header];
            
            rows.forEach(tr => {
                const cells = tr.querySelectorAll('td');
                const rowData = [
                    cells[1].innerText, 
                    cells[2].innerText, 
                    cells[3].innerText, 
                    '',                 
                    cells[4].innerText, 
                    '', '', '', ''      
                ];
                data.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            
            const fileName = getFileName() + (type === 'csv' ? '.csv' : '.xlsx');
            XLSX.writeFile(wb, fileName);
        }

        // =======================
        // å·¥å…·å››ï¼šè¡¨æ ¼è§£æ (ç§»åŠ¨åˆ° Tab 2)
        // =======================
        
        // æ‹–æ‹½ç›¸å…³
        const dropZone = document.getElementById('dropZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            // å¼‚æ­¥ä¾æ¬¡å¤„ç†å¤šä¸ªæ–‡ä»¶
            let fileIndex = 0;
            
            function processNextFile() {
                if (fileIndex >= files.length) {
                    // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæ¯•ï¼Œé‡ç½® input é˜²æ­¢æ— æ³•é€‰æ‹©åŒä¸€æ–‡ä»¶
                    document.getElementById('fileInput').value = '';
                    return;
                }

                const file = files[fileIndex];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // å–ç¬¬ä¸€ä¸ª sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // è½¬ä¸º JSON æ•°æ® (header: 1 è¿”å›æ•°ç»„æ•°ç»„)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    renderExcelTable(jsonData); // æ¸²æŸ“è¿½åŠ 
                    
                    fileIndex++;
                    processNextFile(); // å¤„ç†ä¸‹ä¸€ä¸ª
                };
                reader.readAsArrayBuffer(file);
            }

            processNextFile();
        }

        let currentHeaders = []; // å­˜å‚¨å½“å‰è¡¨å¤´ï¼Œç”¨äºå¤šæ–‡ä»¶åˆå¹¶æ£€æŸ¥

        function renderExcelTable(data) {
            const thead = document.querySelector('#excelTable thead');
            const tbody = document.querySelector('#excelTable tbody');

            if (data.length === 0) return;

            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½æ•°æ®ï¼ˆè¡¨å¤´ä¸ºç©ºï¼‰ï¼Œåˆ™åˆå§‹åŒ–è¡¨å¤´
            let isFirstLoad = thead.innerHTML === '';
            let dataStartIndex = 0;

            if (isFirstLoad) {
                // æ˜¾ç¤ºæ§åˆ¶æ å’Œè¡¨æ ¼
                document.getElementById('excelControls').style.display = 'flex';
                document.getElementById('excelPlaceholder').style.display = 'none';
                document.getElementById('excelTable').style.display = 'table';
                
                currentHeaders = data[0]; // ä¿å­˜è¡¨å¤´
                dataStartIndex = 1; // æ•°æ®ä»ç¬¬äºŒè¡Œå¼€å§‹

                const headerRow = document.createElement('tr');
                const idxTh = document.createElement('th');
                idxTh.textContent = "åºå·";
                headerRow.appendChild(idxTh);

                currentHeaders.forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h || ''; 
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
            } else {
                // å¦‚æœæ˜¯è¿½åŠ æ–‡ä»¶ï¼Œå‡è®¾ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´ï¼Œåº”è¯¥è·³è¿‡
                // ç®€å•å¯¹æ¯”ä¸€ä¸‹è¡¨å¤´æ˜¯å¦ä¸€è‡´ï¼ˆå¯é€‰ï¼‰ï¼Œè¿™é‡Œç›´æ¥è·³è¿‡ç¬¬ä¸€è¡Œ
                dataStartIndex = 1; 
                // å¦‚æœæ–‡ä»¶æœ¬èº«æ²¡è¡¨å¤´ï¼Ÿè¿™é‡Œå‡è®¾ Excel éƒ½æœ‰è¡¨å¤´
            }

            // è·å–å½“å‰å·²æœ‰è¡Œæ•°
            let currentRowCount = tbody.rows.length;

            // å¤„ç†æ•°æ®è¡Œ
            for (let i = dataStartIndex; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue; 

                const tr = document.createElement('tr');
                currentRowCount++;

                // åºå·
                const idxTd = document.createElement('td');
                idxTd.textContent = currentRowCount;
                tr.appendChild(idxTd);

                // æŒ‰ç…§è¡¨å¤´åˆ—æ•°å¡«å……æ•°æ®
                for(let j=0; j < currentHeaders.length; j++) {
                    const td = document.createElement('td');
                    td.textContent = row[j] || '';
                    td.contentEditable = "true";
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            
            document.getElementById('excelRowCount').innerText = currentRowCount;
        }

        function copyExcelContent() {
            const table = document.getElementById('excelTable');
            if (table.style.display === 'none') {
                alert("æ— æ•°æ®å¯å¤åˆ¶");
                return;
            }
            let text = "";
            const rows = table.querySelectorAll('tr');
            rows.forEach((tr, index) => {
                const cells = tr.querySelectorAll('th, td');
                let rowText = [];
                for(let i=1; i<cells.length; i++) {
                    rowText.push(cells[i].innerText);
                }
                text += rowText.join('\t') + '\n';
            });
            copyToClipboard(text);
        }

        // æ–°å¢åŠŸèƒ½ï¼šä»…å¤åˆ¶é€€è´§ç‰©æµå•å·
        function copyReturnLogistics() {
            const table = document.getElementById('excelTable');
            if (table.style.display === 'none') {
                alert("æ— æ•°æ®");
                return;
            }

            // 1. æŸ¥æ‰¾åˆ—ç´¢å¼•
            const headers = table.querySelectorAll('thead th');
            let targetIndex = -1;
            
            // ä»ç´¢å¼• 1 å¼€å§‹ï¼ˆ0æ˜¯åºå·ï¼‰
            for(let i=1; i < headers.length; i++) {
                const txt = headers[i].innerText.trim();
                if (txt.includes("é€€è´§ç‰©æµå•å·") || txt.includes("ç‰©æµå•å·") || txt === "å•å·") {
                    targetIndex = i;
                    break;
                }
            }

            if (targetIndex === -1) {
                alert("æœªæ‰¾åˆ°åŒ…å«â€œé€€è´§ç‰©æµå•å·â€æˆ–â€œç‰©æµå•å·â€çš„åˆ—ï¼");
                return;
            }

            // 2. æå–æ•°æ®
            let text = "";
            const rows = table.querySelectorAll('tbody tr');
            let count = 0;
            rows.forEach(tr => {
                const cells = tr.querySelectorAll('td');
                // cells ç´¢å¼•å¯¹åº” headers ç´¢å¼•
                if (cells[targetIndex]) {
                    text += cells[targetIndex].innerText.trim() + '\n';
                    count++;
                }
            });

            if (count > 0) {
                copyToClipboard(text);
                alert(`å·²å¤åˆ¶ ${count} ä¸ªå•å·`);
            } else {
                alert("æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®");
            }
        }

        function clearExcelData() {
            document.getElementById('fileInput').value = '';
            document.getElementById('excelControls').style.display = 'none';
            document.getElementById('excelTable').style.display = 'none';
            document.getElementById('excelPlaceholder').style.display = 'block';
            document.querySelector('#excelTable thead').innerHTML = '';
            document.querySelector('#excelTable tbody').innerHTML = '';
            document.getElementById('excelRowCount').innerText = '0';
            currentHeaders = [];
        }

        // =======================
        // å·¥å…·ä¸‰ï¼šå•å·æ¯”è¾ƒ (é€»è¾‘ä¿æŒä¸å˜)
        // =======================
        function compareLists() {
            const rawA = document.getElementById('compInputA').value;
            const rawB = document.getElementById('compInputB').value;

            const dataA = getCleanedData(rawA);
            const dataB = getCleanedData(rawB);

            const setA = new Set(dataA.uniqueList);
            const setB = new Set(dataB.uniqueList);

            const common = [...setA].filter(x => setB.has(x));
            const aOnly = [...setA].filter(x => !setB.has(x));
            const bOnly = [...setB].filter(x => !setA.has(x));

            renderResult('resCommon', 'countCommon', common);
            renderResult('resAOnly', 'countAOnly', aOnly);
            renderResult('resBOnly', 'countBOnly', bOnly);
        }

        function renderResult(elemId, countId, list) {
            document.getElementById(elemId).textContent = list.join('\n');
            document.getElementById(countId).textContent = `(${list.length})`;
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).textContent;
            if (!text) return;
            copyToClipboard(text, elementId);
        }
        
        // =======================
        // å·¥å…·å››ï¼šå•å·è½¬æ¢ (åŸ Tab 2ï¼Œç° Tab 4)
        // =======================
        const convertInput = document.getElementById('convertInput');
        const autoRemoveDup = document.getElementById('autoRemoveDup');
        const minLengthInput = document.getElementById('minLength');

        [convertInput, autoRemoveDup, minLengthInput].forEach(el => {
            el.addEventListener('input', () => {
                analyzeData();
                resizeConvertInput(); 
            });
        });

        function getCleanedData(inputStr = null) {
            const raw = inputStr !== null ? inputStr : convertInput.value;
            let items = raw.split(/[\n,ï¼Œ\s]+/).map(s => s.trim()).filter(s => s !== '');
            
            const total = items.length;
            const minLen = parseInt(minLengthInput.value) || 0;

            items = items.map(s => s.replace(/[^a-zA-Z0-9]/g, '')).filter(s => s.length >= minLen);

            const validCountWithDups = items.length;
            const uniqueSet = new Set(items);
            const uniqueItems = Array.from(uniqueSet);
            const isRemove = autoRemoveDup.checked;

            return {
                rawList: items, 
                uniqueList: uniqueItems,
                totalLines: total,
                dupCount: validCountWithDups - uniqueItems.length,
                finalList: isRemove ? uniqueItems : items
            };
        }

        function analyzeData() {
            const data = getCleanedData();
            
            document.getElementById('totalLines').innerText = data.totalLines;
            document.getElementById('validCount').innerText = data.finalList.length;
            document.getElementById('dupCount').innerText = data.dupCount;

            const prefixes = {};
            data.finalList.forEach(item => {
                if (item.length >= 2) {
                    let pre = item.substring(0, 2).toUpperCase();
                    if (/^\d+$/.test(pre)) pre = "æ•°å­—å¼€å¤´";
                    prefixes[pre] = (prefixes[pre] || 0) + 1;
                }
            });

            const sortedPrefixes = Object.entries(prefixes).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const listHtml = sortedPrefixes.map(([k, v]) => 
                `<li><span>${k}</span> <span>${v}</span></li>`
            ).join('');
            document.getElementById('prefixList').innerHTML = listHtml || '<li>æ— æ•°æ®</li>';
        }

        function convertFormat(type) {
            const data = getCleanedData();
            let result = "";
            if (type === 'comma') {
                result = data.finalList.join('ï¼Œ');
            } else {
                result = data.finalList.join('\n');
            }
            convertInput.value = result;
            analyzeData();
            resizeConvertInput();
        }

        function copyConvertResult() {
            convertInput.select();
            document.execCommand('copy');
            alert("ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }


        // --- é€šç”¨å‰ªè´´æ¿å‡½æ•° ---
        function copyToClipboard(text, btnId = null) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            let btn;
            if (btnId) {
                // é’ˆå¯¹æ¯”è¾ƒå·¥å…·çš„æŒ‰é’®å¯»æ‰¾æ–¹å¼
                btn = document.querySelector(`button[onclick="copyText('${btnId}')"]`);
            } else {
                // ç®€å•æŸ¥æ‰¾å½“å‰æ¿€æ´» Tab å†…çš„å¤åˆ¶æŒ‰é’®
                if (document.getElementById('tab2').classList.contains('active')) {
                    // è¡¨æ ¼è§£æ
                    btn = document.querySelector('#excelControls button');
                } else if (document.getElementById('tab1').classList.contains('active')) {
                    // åœ°å€å¤„ç†
                    btn = document.querySelector('button[onclick="copyAddressContent()"]');
                }
            }

            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = "<span>âœ… å·²å¤åˆ¶</span>";
                setTimeout(() => btn.innerHTML = originalText, 1000);
            } else {
                // alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"); 
                // é˜²æ­¢é¢‘ç¹å¼¹çª—ï¼Œè¿™é‡Œé™é»˜æˆ–å°æç¤º
            }
        }

    </script>
</body>
</html>